name: iOS Build & Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-26
    timeout-minutes: 45

    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Select Xcode 26
        run: |
          echo "‚úÖ Using Xcode 26"
          sudo xcode-select -switch /Applications/Xcode.app
      
      - name: Clear SwiftPM protoc artifact cache (workaround)
        run: |
          PROTOC_CACHE=~/Library/Caches/org.swift.swiftpm/artifacts/https___github_com_apple_swift_protobuf_releases_download_protoc_artifactbundle_v31_1_protoc_31_1_artifactbundle_zip
          if [ -e "$PROTOC_CACHE" ]; then
            echo "üßπ Removing stale SwiftPM protoc artifact bundle at $PROTOC_CACHE"
            rm -rf "$PROTOC_CACHE"
          fi

      - name: Show environment info
        run: |
          sw_vers
          xcodebuild -version
          xcrun simctl list devices

      - name: List available Xcode schemes (debugging)
        run: xcodebuild -list
        
      - name: Build Project
        run: |
            xcodebuild clean build \
            -project Momentum.xcodeproj \
            -scheme Momentum \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            ONLY_ACTIVE_ARCH=YES

      - name: Run Unit Tests
        run: |
            xcodebuild test \
            -project Momentum.xcodeproj \
            -scheme Momentum \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            -only-testing:MomentumTests \
            ONLY_ACTIVE_ARCH=YES

      - name: Clean DerivedData for UI Tests
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
            echo "üßπ Cleaning DerivedData before UI tests"
            rm -rf ~/Library/Developer/Xcode/DerivedData/Momentum-*

      - name: Boot & Configure Simulator for UI Tests
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
            echo "üöÄ Setting up simulator for UI tests"

            # Get the device UUID
            DEVICE_UUID=$(xcrun simctl list devices available | grep "iPhone 17 Pro" | grep -v "unavailable" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
            echo "Device UUID: $DEVICE_UUID"
            
            # Shutdown any running simulators
            xcrun simctl shutdown all 2>/dev/null || true
            
            # Erase the simulator to start fresh
            xcrun simctl erase "$DEVICE_UUID" || true
            
            # Boot the simulator
            echo "‚è≥ Booting simulator..."
            xcrun simctl boot "$DEVICE_UUID" || echo "Simulator may already be booted"

            # Wait for simulator to be fully booted using bootstatus (blocks until ready)
            echo "‚è≥ Waiting for simulator to be ready..."
            timeout 120 xcrun simctl bootstatus "$DEVICE_UUID" -b || echo "Simulator boot completed or timeout reached"

            # Additional wait to ensure services are ready
            sleep 3
            echo "‚úÖ Simulator is ready"
            
            # Disable animations and accessibility features that can interfere with UI tests
            echo "‚öôÔ∏è Configuring simulator for UI testing"

            # Disable keyboard helpers and autocorrection
            xcrun simctl ui "$DEVICE_UUID" increase_contrast disable || true
            xcrun simctl ui "$DEVICE_UUID" reduce_motion enable || true

            # Allow time for settings to apply
            sleep 2
            
            # Verify simulator status
            xcrun simctl list devices | grep "iPhone 17 Pro"

            # Give the simulator extra time to settle
            sleep 5

      - name: Build UI Test Target
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
            echo "üî® Building UI test target"
            xcodebuild build-for-testing \
            -project Momentum.xcodeproj \
            -scheme Momentum \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            -only-testing:MomentumUITests \
            ONLY_ACTIVE_ARCH=YES

      - name: Run UI Tests (Main Branch Only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
            echo "üß™ Running UI Tests on main branch"

            # Run tests without building (already built in previous step)
            xcodebuild test-without-building \
            -project Momentum.xcodeproj \
            -scheme Momentum \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
            -only-testing:MomentumUITests \
            ONLY_ACTIVE_ARCH=YES \
            -maximum-concurrent-test-device-destinations 1 \
            -test-timeouts-enabled YES \
            -default-test-execution-time-allowance 120 \
            -maximum-test-execution-time-allowance 180 \
            -resultBundlePath ./UITestResults.xcresult \
            || {
                echo "‚ùå UI Tests failed on first attempt, retrying..."
                sleep 10

                # Retry once on failure
                xcodebuild test-without-building \
                -project Momentum.xcodeproj \
                -scheme Momentum \
                CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
                -sdk iphonesimulator \
                -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=latest' \
                -only-testing:MomentumUITests \
                ONLY_ACTIVE_ARCH=YES \
                -maximum-concurrent-test-device-destinations 1 \
                -test-timeouts-enabled YES \
                -default-test-execution-time-allowance 120 \
                -maximum-test-execution-time-allowance 180 \
                -resultBundlePath ./UITestResults-Retry.xcresult
            }
      
      - name: Upload UI Test Results
        if: always() && (github.event_name == 'push' && github.ref == 'refs/heads/main')
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: |
            UITestResults.xcresult
            UITestResults-Retry.xcresult
          retention-days: 7

#      - name: Build app
#        run: |
#          echo "üöÄ Starting xcodebuild"
#          set -o pipefail && xcodebuild \
#            -scheme Momentum \
#            -sdk iphonesimulator \
#            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=latest' \
#            build | tee xcodebuild.log | xcpretty
#
#      - name: Run Unit/UI Tests
#        run: |
#            echo "üß™ Running Unit/UI Tests"
#            set -o pipefail && xcodebuild \
#            -scheme Momentum \
#            -sdk iphonesimulator \
#            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=latest' \
#            test | tee xctest.log | xcpretty

      - name: Upload test results and logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-and-logs
          path: |
            xcodebuild.log
            xctest.log
            ~/Library/Developer/Xcode/DerivedData/Momentum-*/Logs/Test/
          retention-days: 7
